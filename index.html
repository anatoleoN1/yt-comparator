<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>YouTube Compare Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f1117;
  --card:#1c1f26;
  --text:#ffffff;
  --muted:#9aa0aa;
  --accent:#ff3d00;
  --border:#2a2f3a;
}
.light{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#000000;
  --muted:#555;
  --border:#ddd;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}
.container{
  max-width:1300px;
  margin:auto;
  padding:25px;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
h1{
  margin:0;
  font-size:26px;
}
.controls button, .controls select{
  padding:8px 14px;
  margin-left:6px;
  border-radius:6px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  cursor:pointer;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:20px;
  margin-top:20px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  position:relative;
  overflow:auto;
}
.card h2{margin-top:0;}
.stat{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  color:var(--muted);
}
.stat span{color:var(--text);}
#winner{
  margin:20px 0;
  font-size:22px;
  font-weight:600;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td{
  border-bottom:1px solid var(--border);
  padding:8px;
  text-align:center;
}
th{
  background:rgba(0,0,0,0.1);
}
.badge{
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
.win{background:#2e7d32;color:white;}
.lose{background:#c62828;color:white;}
.tabs{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.tab{
  padding:8px 12px;
  border:1px solid var(--border);
  background:var(--card);
  cursor:pointer;
  border-radius:8px;
}
.tab.active{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(255,61,0,0.25);
}
.hidden{display:none;}
.inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.small{
  font-size:12px;
  color:var(--muted);
}
.hr{height:1px;background:var(--border);margin:14px 0;}
/* FIX: contraindre la hauteur des canvas pour √©viter l'√©tirement infini */
canvas{width:100% !important; max-width:100%; height:220px !important; display:block;}
.analysis-container{margin-top:8px;}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>üìä YouTube Compare ‚Äî Pro Dashboard</h1>
  <div class="controls">
    <select id="metric" onchange="updateMainChart()">
      <option value="subs">Abonn√©s</option>
      <option value="views">Vues</option>
      <option value="videos">Vid√©os</option>
    </select>
    <select id="topN" onchange="renderGlobalRanking()">
      <option value="5">Top 5</option>
      <option value="10" selected>Top 10</option>
      <option value="20">Top 20</option>
    </select>
    <button onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
    <button onclick="forceApi()">üîÑ API</button>
    <button onclick="exportCSV()">üì• CSV</button>
    <button onclick="resetLocal()">üßπ Reset cache</button>
  </div>
</header>

<div id="winner"></div>

<div class="grid">
  <div class="card">
    <h2>üìà Timeline multi-cha√Ænes</h2>
    <canvas id="mainChart" height="220"></canvas>
  </div>
  <div class="card">
    <h2>üèÜ Classement global multi-cha√Ænes</h2>
    <div class="inline">
      <span class="small">Top N :</span>
      <select id="globalSort" onchange="renderGlobalRanking()">
        <option value="globalScore" selected>Score global</option>
        <option value="growthScore">Croissance</option>
        <option value="engagementScore">Engagement estim√©</option>
        <option value="subs">Abonn√©s</option>
        <option value="views">Vues</option>
        <option value="videos">Vid√©os</option>
      </select>
    </div>
    <table id="globalTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Cha√Æne</th>
          <th>Score global</th>
          <th>Croissance</th>
          <th>Engagement</th>
          <th>Subs</th>
          <th>Vues</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card">
  <h2>üìå Dashboard par cha√Æne (onglets)</h2>
  <div id="tabs" class="tabs"></div>
  <div id="channelDash"></div>
</div>

<div class="card">
  <h2>üß† Mode Analyse</h2>
  <div class="inline">
    <button onclick="renderAnalysis()">üìä Analyse</button>
    <button onclick="renderRadar()">üï∏Ô∏è Radar</button>
  </div>

  <div class="hr"></div>

  <div id="analysisArea" class="analysis-container"></div>
</div>

<div class="card">
  <h2>üèÜ Historique des classements</h2>
  <table id="rankingTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>1er</th>
        <th>Score</th>
        <th>2e</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script>
// ================= CONFIG =================
const API_KEY = "AIzaSyBNjEv-yOwdUJr1dANWrNDA0sudTxIYcjs";
const CHANNELS = [
  "UCEY9shLd79aYWqaKC3RBBSQ",
  "UCGp_T6KS9YEORdWqS_Ea-Ig",
  "UCufy5NnhR8HK9-UL34CCI_g",
  "UCq8kw889lexw0nEHEhbLFSg",
  "UC4G1JbAPGpH5LyRVmAleryg",
  "UCM2SF36MTAKwvkX0jem7Jeg",
];

const API_CACHE_HOURS = 1;
const UI_REFRESH_MIN = 2;
const CACHE_VERSION = 3;
// =========================================

let mainChart;
let channelCharts = {};
let radarChart;

// theme persist
if(localStorage.getItem("theme")==="light")
  document.body.classList.add("light");

function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme",
    document.body.classList.contains("light")?"light":"dark");
}

function resetLocal(){
  localStorage.removeItem("ytCache");
  localStorage.removeItem("ytHistory");
  localStorage.removeItem("ytRanking");
  alert("Cache supprim√© !");
  init();
}

// --------- Helpers ---------
function getColor(i, alpha = 1){
  // simple HSL palette
  const hue = (i * 47) % 360;
  return `hsla(${hue}, 85%, 55%, ${alpha})`;
}

// --------- Fetch API ---------
async function fetchChannel(id){
  const r = await fetch(
    `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${id}&key=${API_KEY}`
  );
  return (await r.json()).items?.[0];
}

function cleanHistory(h){
  return (h || []).filter(x =>
    x &&
    x.c &&
    x.c.subs != null && x.c.views != null && x.c.videos != null
  );
}

async function getData(){
  const cache = JSON.parse(localStorage.getItem("ytCache"));
  const now = Date.now();

  if(cache && cache.version === CACHE_VERSION && now - cache.time < API_CACHE_HOURS*3600000){
    return cache.data;
  }

  const channels = [];
  for(const id of CHANNELS){
    try{
      const c = await fetchChannel(id);
      if(c) channels.push(c);
    }catch(e){
      console.warn("Erreur fetchChannel", id, e);
    }
  }

  localStorage.setItem("ytCache", JSON.stringify({
    version: CACHE_VERSION,
    time: now,
    data: channels
  }));

  saveHistory(channels);
  saveRanking(channels);

  return channels;
}

// --------- Scores ---------
function scoreBase(c){
  const subs = +c.statistics.subscriberCount;
  const views = +c.statistics.viewCount;
  const videos = +c.statistics.videoCount;

  const subsNorm = Math.log10(subs + 1);
  const viewsNorm = Math.log10(views + 1);
  const videosNorm = Math.log10(videos + 1);

  const rawScore = subsNorm * 0.5 + viewsNorm * 0.4 + videosNorm * 0.1;
  return Math.round(rawScore * 10); // sur 100
}

function growthScore(channel){
  const history = cleanHistory(JSON.parse(localStorage.getItem("ytHistory")));
  if(!history || history.length < 2) return 0;

  const start = history[0].c[channel.id];
  const end = history[history.length-1].c[channel.id];
  if(!start || !end) return 0;

  const subsGrowth = (end.subs - start.subs) / Math.max(1, start.subs);
  const viewsGrowth = (end.views - start.views) / Math.max(1, start.views);
  const vidsGrowth = (end.videos - start.videos) / Math.max(1, start.videos);

  const raw = subsGrowth*0.5 + viewsGrowth*0.4 + vidsGrowth*0.1;
  return Math.round(raw * 100); // %
}

function engagementScore(channel){
  const views = +channel.statistics.viewCount;
  const subs = +channel.statistics.subscriberCount;
  const videos = +channel.statistics.videoCount;

  const ratio = views / Math.max(1, subs);
  const activity = videos / Math.max(1, Math.log10(subs+1)*10);
  const raw = Math.log10(ratio + 1) * 0.7 + Math.log10(activity + 1) * 0.3;
  return Math.round(raw * 100);
}

function globalScore(channel){
  const base = scoreBase(channel);
  const growth = growthScore(channel);
  const engagement = engagementScore(channel);
  return Math.round(base*0.6 + growth*0.25 + engagement*0.15);
}

// --------- History ---------
function saveHistory(channels){
  const h = JSON.parse(localStorage.getItem("ytHistory"))||[];
  const entry = { time: new Date().toLocaleString(), c:{} };
  channels.forEach((c, idx) => {
    if(!c || !c.id || !c.statistics) return;
    entry.c[c.id] = {
      subs:+c.statistics.subscriberCount,
      views:+c.statistics.viewCount,
      videos:+c.statistics.videoCount
    };
  });
  h.push(entry);
  localStorage.setItem("ytHistory", JSON.stringify(h));
}

function saveRanking(channels){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  if(!Array.isArray(channels) || channels.length < 2) return;

  const sorted = channels.slice().sort((a,b)=>globalScore(b)-globalScore(a));
  r.push({
    time:new Date().toLocaleString(),
    first: sorted[0].snippet.title,
    firstScore: globalScore(sorted[0]),
    second: sorted[1].snippet.title,
    secondScore: globalScore(sorted[1])
  });

  localStorage.setItem("ytRanking", JSON.stringify(r));
}

function updateRankingTable(){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  const body = document.querySelector("#rankingTable tbody");
  body.innerHTML="";
  r.slice().reverse().forEach(e=>{
    body.innerHTML += `
      <tr>
        <td>${e.time}</td>
        <td><span class="badge win">${e.first}</span></td>
        <td>${Math.round(e.firstScore).toLocaleString()}</td>
        <td><span class="badge lose">${e.second}</span></td>
        <td>${Math.round(e.secondScore).toLocaleString()}</td>
      </tr>
    `;
  });
}

// --------- Main chart (timeline multi-cha√Ænes) ---------
function updateMainChart(){
  const metric = document.getElementById("metric").value;
  const h = cleanHistory(JSON.parse(localStorage.getItem("ytHistory")) || []);

  if(mainChart) mainChart.destroy();

  const cachedChannels = JSON.parse(localStorage.getItem("ytCache"))?.data || [];

  if(!cachedChannels || cachedChannels.length === 0){
    const ctxEl = document.getElementById("mainChart");
    const ctx = ctxEl.getContext ? ctxEl.getContext("2d") : null;
    if(ctx){
      mainChart = new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [] },
        options: {
          plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { display: false } },
          maintainAspectRatio: true
        }
      });
    }
    return;
  }

  const labels = h.map(e => e.time);
  const datasets = cachedChannels.map((c, idx) => ({
    label: c.snippet?.title || `Cha√Æne ${idx+1}`,
    data: h.map(e => e.c?.[c.id]?.[metric] ?? 0),
    tension:0.2,
    borderColor: getColor(idx),
    backgroundColor: getColor(idx, 0.12),
    pointRadius: 2,
    fill: false
  }));

  const ctx = document.getElementById("mainChart").getContext("2d");
  mainChart = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets
    },
    options:{
      responsive:true,
      maintainAspectRatio:true
    }
  });
}

// --------- Global ranking ---------
function renderGlobalRanking(){
  const sortBy = document.getElementById("globalSort").value;
  const topN = parseInt(document.getElementById("topN").value, 10);

  const body = document.querySelector("#globalTable tbody");
  body.innerHTML="";

  const channels = JSON.parse(localStorage.getItem("ytCache"))?.data || [];
  if(!Array.isArray(channels) || channels.length === 0) return;

  const sorted = channels.slice().sort((a,b)=>{
    if(sortBy === "subs") return +b.statistics.subscriberCount - +a.statistics.subscriberCount;
    if(sortBy === "views") return +b.statistics.viewCount - +a.statistics.viewCount;
    if(sortBy === "videos") return +b.statistics.videoCount - +a.statistics.videoCount;
    if(sortBy === "growthScore") return growthScore(b) - growthScore(a);
    if(sortBy === "engagementScore") return engagementScore(b) - engagementScore(a);
    return globalScore(b) - globalScore(a);
  });

  sorted.slice(0, topN).forEach((c, i) => {
    body.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${c.snippet.title}</td>
        <td>${globalScore(c).toLocaleString()}</td>
        <td>${growthScore(c).toLocaleString()}%</td>
        <td>${engagementScore(c).toLocaleString()}</td>
        <td>${(+c.statistics.subscriberCount).toLocaleString()}</td>
        <td>${(+c.statistics.viewCount).toLocaleString()}</td>
      </tr>
    `;
  });
}

// --------- Dashboard par cha√Æne ---------
function renderTabs(channels){
  const tabs = document.getElementById("tabs");
  tabs.innerHTML="";

  channels.forEach((c, idx)=>{
    const tab = document.createElement("div");
    tab.className = "tab" + (idx===0 ? " active" : "");
    tab.textContent = c.snippet.title;
    tab.onclick = () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      renderChannelDashboard(c);
    };
    tabs.appendChild(tab);
  });
}

function renderChannelDashboard(channel){
  const dash = document.getElementById("channelDash");
  dash.innerHTML = `
    <h3>${channel.snippet?.title || ''}</h3>
    <div class="grid">
      <div class="card">
        <h2>üìå Stats</h2>
        <div class="stat">Score global <span>${channel && channel.statistics ? globalScore(channel) : 0} / 100</span></div>
        <div class="stat">Croissance <span>${channel && channel.statistics ? growthScore(channel) : 0}%</span></div>
        <div class="stat">Engagement <span>${channel && channel.statistics ? engagementScore(channel) : 0}</span></div>
        <div class="stat">Abonn√©s <span>${channel && channel.statistics ? (+channel.statistics.subscriberCount).toLocaleString() : "N/A"}</span></div>
        <div class="stat">Vues <span>${channel && channel.statistics ? (+channel.statistics.viewCount).toLocaleString() : "N/A"}</span></div>
        <div class="stat">Vid√©os <span>${channel && channel.statistics ? (+channel.statistics.videoCount).toLocaleString() : "N/A"}</span></div>
      </div>

      <div class="card">
        <h2>üìà Graphiques</h2>
        <canvas id="chart_${channel.id || 'empty'}" height="220"></canvas>
      </div>
    </div>
  `;

  setTimeout(() => {
    if(channel && channel.id) renderChannelChart(channel);
  }, 50);
}

function renderChannelChart(channel){
  const history = cleanHistory(JSON.parse(localStorage.getItem("ytHistory")) || []);
  const canvasEl = document.getElementById(`chart_${channel.id}`);
  if(!canvasEl) return;

  if(channelCharts[channel.id]) channelCharts[channel.id].destroy();

  const ctx = canvasEl.getContext('2d');
  const baseIdx = CHANNELS.indexOf(channel.id);
  channelCharts[channel.id] = new Chart(ctx, {
    type:"line",
    data:{
      labels: history.map(e => e.time),
      datasets:[
        { label:"Abonn√©s", data: history.map(e => e.c[channel.id]?.subs ?? 0), tension:0.2, borderColor: getColor(baseIdx*3+0), backgroundColor: getColor(baseIdx*3+0,0.12), pointRadius:1 },
        { label:"Vues",    data: history.map(e => e.c[channel.id]?.views ?? 0), tension:0.2, borderColor: getColor(baseIdx*3+1), backgroundColor: getColor(baseIdx*3+1,0.12), pointRadius:1 },
        { label:"Vid√©os",  data: history.map(e => e.c[channel.id]?.videos ?? 0), tension:0.2, borderColor: getColor(baseIdx*3+2), backgroundColor: getColor(baseIdx*3+2,0.12), pointRadius:1 }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true
    }
  });
}

// --------- Analyse & Radar ---------
function renderAnalysis(){
  const channels = JSON.parse(localStorage.getItem("ytCache"))?.data || [];
  const history = cleanHistory(JSON.parse(localStorage.getItem("ytHistory")) || []);
  const area = document.getElementById("analysisArea");
  area.innerHTML = "";

  if(channels.length === 0) {
    area.innerHTML = `<div class="small">Aucune donn√©e disponible pour l'analyse.</div>`;
    return;
  }

  const last = history[history.length-1];

  const html = channels.map(c => {
    const h = last?.c?.[c.id];
    return `
      <div class="card">
        <h3>${c.snippet.title}</h3>
        <div class="stat">Derni√®re capture <span>${h ? h.subs.toLocaleString() : "N/A"} subs</span></div>
        <div class="stat">Croissance <span>${growthScore(c)}%</span></div>
        <div class="stat">Engagement <span>${engagementScore(c)}</span></div>
        <div class="stat">Score global <span>${globalScore(c)}</span></div>
      </div>
    `;
  }).join("");

  area.innerHTML = `<div class="grid">${html}</div>`;
}

function renderRadar(){
  const channels = JSON.parse(localStorage.getItem("ytCache"))?.data || [];
  const area = document.getElementById("analysisArea");
  area.innerHTML = `
    <div class="card">
      <h3>Radar de performance</h3>
      <canvas id="radarChart" height="220"></canvas>
    </div>
  `;

  if(channels.length === 0){
    area.innerHTML = `<div class="small">Aucune donn√©e disponible pour le radar.</div>`;
    return;
  }

  const labels = ["Global", "Croissance", "Engagement", "Subs", "Vues"];
  const datasets = channels.map((c, idx) => ({
    label: c.snippet.title,
    data: [
      globalScore(c),
      growthScore(c),
      engagementScore(c),
      Math.log10(+c.statistics.subscriberCount + 1) * 20,
      Math.log10(+c.statistics.viewCount + 1) * 20
    ],
    fill:true,
    backgroundColor: getColor(idx, 0.18),
    borderColor: getColor(idx),
    pointBackgroundColor: getColor(idx)
  }));

  if(radarChart) radarChart.destroy();

  const ctx = document.getElementById("radarChart").getContext("2d");
  radarChart = new Chart(ctx, {
    type:"radar",
    data:{ labels, datasets },
    options:{ responsive:true, maintainAspectRatio:true }
  });
}

// --------- CSV Export ---------
function exportCSV(){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  let csv="Date,1er,Score,2e,Score\n";
  r.forEach(e=>{
    csv+=`${e.time},${e.first},${e.firstScore},${e.second},${e.secondScore}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="youtube_ranking.csv";
  a.click();
}

// --------- Init ---------
function computeWinner(channels){
  if(!channels || channels.length === 0) {
    document.getElementById("winner").textContent = "";
    return;
  }
  const sorted = channels.slice().sort((a,b)=>globalScore(b)-globalScore(a));
  const top = sorted[0];
  document.getElementById("winner").textContent =
    `üèÜ ${top.snippet.title} domine actuellement (score global: ${globalScore(top)})`;
}

function renderAll(channels){
  renderTabs(channels);
  renderChannelDashboard(channels[0] || {});
  updateMainChart();
  renderGlobalRanking();
  updateRankingTable();
  computeWinner(channels);
}

async function forceApi(){
  localStorage.removeItem("ytCache");
  const channels = await getData();
  renderAll(channels);
}

async function init(){
  const channels = await getData();
  renderAll(channels);
}

setInterval(init, UI_REFRESH_MIN * 60000);
init();

</script>
</body>
</html>
