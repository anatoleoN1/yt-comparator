<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>YouTube Compare Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f1117;
  --card:#1c1f26;
  --text:#fff;
  --muted:#9aa0aa;
  --accent:#ff3d00;
  --border:#2a2f3a;
}
.light{
  --bg:#f4f6fb;
  --card:#fff;
  --text:#000;
  --muted:#555;
  --accent:#ff3d00;
  --border:#ddd;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}
.container{
  max-width:1300px;
  margin:auto;
  padding:25px;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
h1{margin:0;font-size:26px;}
.controls button, select{
  padding:8px 14px;
  margin-left:6px;
  border-radius:6px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  cursor:pointer;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:20px;
  margin-top:20px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
}
.card h2{margin-top:0;}
.stat{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  color:var(--muted);
}
.stat span{color:var(--text);}
#winner{
  margin:20px 0;
  font-size:22px;
  font-weight:600;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border-bottom:1px solid var(--border);
  padding:8px;
  text-align:center;
}
th{background:rgba(0,0,0,0.1);}
.badge{
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
.win{background:#2e7d32;color:white;}
.lose{background:#c62828;color:white;}
/* DASHBOARD */
.dashboard{
  margin-top:20px;
}
.tabs{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.tab{
  padding:8px 12px;
  border:1px solid var(--border);
  background:var(--card);
  cursor:pointer;
  border-radius:8px;
}
.tab.active{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(255,61,0,0.15);
}
.analysis{
  margin-top:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:20px;
}
.analysis .card{
  padding:16px;
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>üìä YouTube Compare ‚Äî Pro Dashboard</h1>
  <div class="controls">
    <select id="metric" onchange="updateChart()">
      <option value="subs">Abonn√©s</option>
      <option value="views">Vues</option>
      <option value="videos">Vid√©os</option>
      <option value="growth">Croissance</option>
      <option value="engagement">Engagement</option>
      <option value="global">Score global</option>
    </select>
    <button onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
    <button onclick="forceApi()">üîÑ API</button>
    <button onclick="exportCSV()">üì• CSV</button>
  </div>
</header>

<div id="winner"></div>

<div class="grid" id="channelGrid"></div>

<div class="card">
  <h2>üìà √âvolution</h2>
  <canvas id="chart" height="120"></canvas>
</div>

<div class="card">
  <h2>üèÜ Classement global multi-cha√Ænes</h2>
  <div class="controls">
    <button onclick="setTop(5)">Top 5</button>
    <button onclick="setTop(10)">Top 10</button>
    <button onclick="setTop(50)">Top 50</button>
  </div>
  <table id="globalTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Cha√Æne</th>
        <th>Score global</th>
        <th>Pro</th>
        <th>Engagement</th>
        <th>Croissance</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card dashboard">
  <h2>üìå Dashboard par cha√Æne</h2>
  <div class="tabs" id="tabs"></div>
  <div id="dashContent"></div>
</div>

<div class="card">
  <h2>üß≠ Mode Analyse</h2>
  <div class="analysis" id="analysis"></div>
</div>

</div>

<script>
// ============== CONFIG ==============
const API_KEY = "AIzaSyBNjEv-yOwdUJr1dANWrNDA0sudTxIYcjs";
const CHANNELS = [
  "UCEY9shLd79aYWqaKC3RBBSQ",
  "UCGp_T6KS9YEORdWqS_Ea-Ig",
  "UCufy5NnhR8HK9-UL34CCI_g",
  "UCq8kw889lexw0nEHEhbLFSg",
  "UC4G1JbAPGpH5LyRVmAleryg",
  "UCM2SF36MTAKwvkX0jem7Jeg",
];

const API_CACHE_HOURS = 1;
const UI_REFRESH_MIN = 2;
// ===================================

let chart, topN = 10;

// Theme persist
if(localStorage.getItem("theme")==="light")
  document.body.classList.add("light");

function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme",
    document.body.classList.contains("light")?"light":"dark");
}

async function fetchChannel(id){
  const r = await fetch(
    `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${id}&key=${API_KEY}`
  );
  return (await r.json()).items[0];
}

async function getData(){
  const cache = JSON.parse(localStorage.getItem("ytCache"));
  const now = Date.now();
  if(cache && now-cache.time < API_CACHE_HOURS*3600000)
    return cache.data;

  const data = await Promise.all(CHANNELS.map(fetchChannel));
  localStorage.setItem("ytCache",JSON.stringify({time:now,data}));
  saveHistory(data);
  saveRanking(data);
  return data;
}

// ====== SCORES ======
function scorePro(c) {
  const subs = +c.statistics.subscriberCount;
  const views = +c.statistics.viewCount;
  const videos = +c.statistics.videoCount;

  const subsNorm   = Math.log10(subs + 1);
  const viewsNorm  = Math.log10(views + 1);
  const videosNorm = Math.log10(videos + 1);

  const rawScore =
    subsNorm * 0.5 +
    viewsNorm * 0.4 +
    videosNorm * 0.1;

  return Math.round(rawScore * 10);
}

function engagementScore(c){
  const subs = +c.statistics.subscriberCount;
  const views = +c.statistics.viewCount;
  const videos = +c.statistics.videoCount;

  const raw = (views/(subs+1))*0.7 + (videos/(subs+1))*0.3;
  return Math.round(Math.log10(raw + 1) * 20);
}

function growthScore(id, currentSubs){
  const hist = JSON.parse(localStorage.getItem("ytHistory")) || [];
  const last = hist.filter(h => h.channels.some(ch => ch.id === id)).slice(-1)[0];

  if(!last) return 0;

  const prev = last.channels.find(ch => ch.id === id);
  const growth = (currentSubs - prev.subs) / (prev.subs + 1);
  return Math.round(Math.max(0, Math.min(growth * 100, 100)));
}

function globalScore(c){
  const s = scorePro(c);
  const e = engagementScore(c);
  const g = growthScore(c.id, +c.statistics.subscriberCount);
  return Math.round(s*0.5 + e*0.3 + g*0.2);
}

// ====== HISTORIQUE ======
function saveHistory(channels){
  const h = JSON.parse(localStorage.getItem("ytHistory"))||[];
  const entry = {
    time:new Date().toLocaleString(),
    channels: channels.map(c=>({
      id:c.id,
      title:c.snippet.title,
      subs:+c.statistics.subscriberCount,
      views:+c.statistics.viewCount,
      videos:+c.statistics.videoCount
    }))
  };
  h.push(entry);
  localStorage.setItem("ytHistory",JSON.stringify(h));
}

function saveRanking(channels){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  const ranked = channels.map(c=>({
    title:c.snippet.title,
    score:globalScore(c),
    pro:scorePro(c),
    eng:engagementScore(c),
    growth: growthScore(c.id, +c.statistics.subscriberCount)
  })).sort((a,b)=>b.score-a.score);

  r.push({
    time:new Date().toLocaleString(),
    ranking: ranked
  });
  localStorage.setItem("ytRanking",JSON.stringify(r));
}

// ====== UI ======
function displayChannels(channels){
  const grid = document.getElementById("channelGrid");
  grid.innerHTML = "";
  channels.forEach(c=>{
    const s = scorePro(c);
    const e = engagementScore(c);
    const g = growthScore(c.id, +c.statistics.subscriberCount);
    const glob = globalScore(c);

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <h2>${c.snippet.title}</h2>
      <div class="stat">Score global <span>${glob} / 100</span></div>
      <div class="stat">Score pro <span>${s}</span></div>
      <div class="stat">Engagement <span>${e}</span></div>
      <div class="stat">Croissance <span>${g}</span></div>
      <div class="stat">Abonn√©s <span>${(+c.statistics.subscriberCount).toLocaleString()}</span></div>
      <div class="stat">Vues <span>${(+c.statistics.viewCount).toLocaleString()}</span></div>
      <div class="stat">Vid√©os <span>${(+c.statistics.videoCount).toLocaleString()}</span></div>
    `;
    grid.appendChild(card);
  });
}

function updateRankingTable(){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  const body = document.querySelector("#globalTable tbody");
  body.innerHTML="";

  const latest = r.slice(-1)[0];
  if(!latest) return;

  latest.ranking.slice(0, topN).forEach((e,i)=>{
    body.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${e.title}</td>
        <td>${e.score}</td>
        <td>${e.pro}</td>
        <td>${e.eng}</td>
        <td>${e.growth}</td>
      </tr>
    `;
  });
}

function setTop(n){
  topN = n;
  updateRankingTable();
}

function updateChart(){
  const metric = document.getElementById("metric").value;
  const h = JSON.parse(localStorage.getItem("ytHistory")) || [];

  if(chart) chart.destroy();

  const labels = h.map(e => e.time);
  const datasets = CHANNELS.map((id, idx)=>{
    return {
      label: "Cha√Æne " + (idx+1),
      data: h.map(e => e.channels[idx][metric]),
      tension:0.2
    };
  });

  chart = new Chart(document.getElementById("chart"), {
    type:"line",
    data:{
      labels,
      datasets
    }
  });
}

function computeWinner(channels){
  const ranked = channels.map(c=>({title:c.snippet.title, score:globalScore(c)}))
    .sort((a,b)=>b.score-a.score);

  const winner = ranked[0];
  document.getElementById("winner").textContent =
    `üèÜ ${winner.title} domine actuellement avec ${winner.score} / 100`;
}

// ===== DASHBOARD PAR CHAINE =====
function buildDashboard(channels){
  const tabs = document.getElementById("tabs");
  const content = document.getElementById("dashContent");
  tabs.innerHTML = "";
  content.innerHTML = "";

  channels.forEach((c, idx)=>{
    const btn = document.createElement("div");
    btn.className="tab";
    btn.textContent = c.snippet.title;
    btn.onclick = () => showDash(idx, channels);
    tabs.appendChild(btn);
  });

  showDash(0, channels);
}

function showDash(idx, channels){
  const content = document.getElementById("dashContent");
  const c = channels[idx];

  content.innerHTML = `
    <div class="card">
      <h2>${c.snippet.title}</h2>
      <canvas id="dashChart" height="120"></canvas>
    </div>
  `;

  const h = JSON.parse(localStorage.getItem("ytHistory")) || [];
  const labels = h.map(e=>e.time);
  const dataSubs = h.map(e=>e.channels[idx].subs);
  const dataViews = h.map(e=>e.channels[idx].views);
  const dataVideos = h.map(e=>e.channels[idx].videos);

  new Chart(document.getElementById("dashChart"), {
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Abonn√©s", data:dataSubs, tension:0.2},
        {label:"Vues", data:dataViews, tension:0.2},
        {label:"Vid√©os", data:dataVideos, tension:0.2}
      ]
    }
  });
}

// ===== MODE ANALYSE =====
function renderAnalysis(channels){
  const div = document.getElementById("analysis");
  div.innerHTML = "";

  channels.forEach(c=>{
    const e = engagementScore(c);
    const g = growthScore(c.id, +c.statistics.subscriberCount);
    const glob = globalScore(c);

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <h3>${c.snippet.title}</h3>
      <div class="stat">Score global <span>${glob}</span></div>
      <div class="stat">Engagement <span>${e}</span></div>
      <div class="stat">Croissance <span>${g}</span></div>
      <div class="stat">Abonn√©s <span>${(+c.statistics.subscriberCount).toLocaleString()}</span></div>
      <div class="stat">Vues <span>${(+c.statistics.viewCount).toLocaleString()}</span></div>
    `;
    div.appendChild(card);
  });
}

// ===== EXPORT CSV =====
function exportCSV(){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  let csv="Date,Rank,Cha√Æne,Score global,Pro,Engagement,Croissance\n";
  const latest = r.slice(-1)[0];
  if(!latest) return;

  latest.ranking.forEach((e,i)=>{
    csv += `${latest.time},${i+1},${e.title},${e.score},${e.pro},${e.eng},${e.growth}\n`;
  });

  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="youtube_global_ranking.csv";
  a.click();
}

function forceApi(){
  localStorage.removeItem("ytCache");
  init();
}

async function init(){
  const channels = await getData();
  displayChannels(channels);
  updateChart();
  updateRankingTable();
  computeWinner(channels);
  buildDashboard(channels);
  renderAnalysis(channels);
}

setInterval(init, UI_REFRESH_MIN*60000);
init();
</script>
</body>
</html>
