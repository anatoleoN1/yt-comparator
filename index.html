<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>YouTube Compare Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg:#0f1117;
  --card:#1c1f26;
  --text:#ffffff;
  --muted:#9aa0aa;
  --accent:#ff3d00;
  --border:#2a2f3a;
}
.light {
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#000000;
  --muted:#555;
  --border:#ddd;
}
* { box-sizing:border-box; }
body {
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}
.container {
  max-width:1300px;
  margin:auto;
  padding:25px;
}
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
h1 {
  margin:0;
  font-size:26px;
}
.controls button, select {
  padding:8px 14px;
  margin-left:6px;
  border-radius:6px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  cursor:pointer;
}
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:20px;
  margin-top:20px;
}
.card {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
}
.card h2 {
  margin-top:0;
}
.stat {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  color:var(--muted);
}
.stat span {
  color:var(--text);
}
#winner {
  margin:20px 0;
  font-size:22px;
  font-weight:600;
}
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td {
  border-bottom:1px solid var(--border);
  padding:8px;
  text-align:center;
}
th {
  background:rgba(0,0,0,0.1);
}
.badge {
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
.win { background:#2e7d32; color:white; }
.lose { background:#c62828; color:white; }
</style>
</head>

<body>
<div class="container">

<header>
  <h1>üìä YouTube Compare ‚Äî Pro Dashboard</h1>
  <div class="controls">
    <select id="metric" onchange="updateChart()">
      <option value="subs">Abonn√©s</option>
      <option value="views">Vues</option>
      <option value="videos">Vid√©os</option>
    </select>
    <button onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
    <button onclick="forceApi()">üîÑ API</button>
    <button onclick="exportCSV()">üì• CSV</button>
  </div>
</header>

<div id="winner"></div>

<div class="grid">
  <div class="card" id="c1"></div>
  <div class="card" id="c2"></div>
</div>

<div class="card">
  <h2>üìà √âvolution</h2>
  <canvas id="chart" height="120"></canvas>
</div>

<div class="card">
  <h2>üèÜ Historique des classements</h2>
  <table id="rankingTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>1er</th>
        <th>Score</th>
        <th>2e</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script>
// ============== CONFIG ==============
const API_KEY = "AIzaSyBNjEv-yOwdUJr1dANWrNDA0sudTxIYcjs";
const CHANNEL_1 = "UCEY9shLd79aYWqaKC3RBBSQ";
const CHANNEL_2 = "UCGp_T6KS9YEORdWqS_Ea-Ig";

const API_CACHE_HOURS = 1;
const UI_REFRESH_MIN = 2;

const SUB_WEIGHT = 0.6;
const VIEW_WEIGHT = 0.4;
// ===================================

let chart;

// Theme persist
if(localStorage.getItem("theme")==="light")
  document.body.classList.add("light");

function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme",
    document.body.classList.contains("light")?"light":"dark");
}

async function fetchChannel(id){
  const r = await fetch(
    `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${id}&key=${API_KEY}`
  );
  return (await r.json()).items[0];
}

async function getData(){
  const cache = JSON.parse(localStorage.getItem("ytCache"));
  const now = Date.now();
  if(cache && now-cache.time < API_CACHE_HOURS*3600000)
    return cache.data;

  const c1 = await fetchChannel(CHANNEL_1);
  const c2 = await fetchChannel(CHANNEL_2);
  const data = {c1,c2};
  localStorage.setItem("ytCache",JSON.stringify({time:now,data}));
  saveHistory(c1,c2);
  saveRanking(c1,c2);
  return data;
}

function display(c,id){
  document.getElementById(id).innerHTML = `
    <h2>${c.snippet.title}</h2>
    <div class="stat">Abonn√©s <span>${(+c.statistics.subscriberCount).toLocaleString()}</span></div>
    <div class="stat">Vues <span>${(+c.statistics.viewCount).toLocaleString()}</span></div>
    <div class="stat">Vid√©os <span>${(+c.statistics.videoCount).toLocaleString()}</span></div>
  `;
}

function score(c){
  return c.statistics.subscriberCount*SUB_WEIGHT +
         c.statistics.viewCount*VIEW_WEIGHT;
}

function saveHistory(c1,c2){
  const h = JSON.parse(localStorage.getItem("ytHistory"))||[];
  h.push({
    time:new Date().toLocaleString(),
    c1:{subs:+c1.statistics.subscriberCount,views:+c1.statistics.viewCount,videos:+c1.statistics.videoCount},
    c2:{subs:+c2.statistics.subscriberCount,views:+c2.statistics.viewCount,videos:+c2.statistics.videoCount}
  });
  localStorage.setItem("ytHistory",JSON.stringify(h));
}

function saveRanking(c1,c2){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  const s1 = score(c1), s2 = score(c2);
  r.push({
    time:new Date().toLocaleString(),
    first: s1>s2?c1.snippet.title:c2.snippet.title,
    firstScore:Math.max(s1,s2),
    second: s1>s2?c2.snippet.title:c1.snippet.title,
    secondScore:Math.min(s1,s2)
  });
  localStorage.setItem("ytRanking",JSON.stringify(r));
}

function updateRankingTable(){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  const body = document.querySelector("#rankingTable tbody");
  body.innerHTML="";
  r.slice().reverse().forEach(e=>{
    body.innerHTML += `
      <tr>
        <td>${e.time}</td>
        <td><span class="badge win">${e.first}</span></td>
        <td>${Math.round(e.firstScore).toLocaleString()}</td>
        <td><span class="badge lose">${e.second}</span></td>
        <td>${Math.round(e.secondScore).toLocaleString()}</td>
      </tr>
    `;
  });
}

function updateChart(){
  const metric = document.getElementById("metric").value;
  const h = JSON.parse(localStorage.getItem("ytHistory"))||[];
  if(chart) chart.destroy();
  chart = new Chart(chartCanvas,{
    type:"line",
    data:{
      labels:h.map(e=>e.time),
      datasets:[
        {label:"Cha√Æne 1",data:h.map(e=>e.c1[metric]),borderColor:"#ff3d00"},
        {label:"Cha√Æne 2",data:h.map(e=>e.c2[metric]),borderColor:"#2979ff"}
      ]
    }
  });
}

function computeWinner(c1,c2){
  const s1=score(c1), s2=score(c2);
  document.getElementById("winner").textContent =
    s1>s2?`üèÜ ${c1.snippet.title} domine actuellement`:
    s2>s1?`üèÜ ${c2.snippet.title} domine actuellement`:
    "ü§ù √âgalit√© parfaite";
}

function exportCSV(){
  const r = JSON.parse(localStorage.getItem("ytRanking"))||[];
  let csv="Date,1er,Score,2e,Score\n";
  r.forEach(e=>{
    csv+=`${e.time},${e.first},${e.firstScore},${e.second},${e.secondScore}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="youtube_ranking.csv";
  a.click();
}

function forceApi(){
  localStorage.removeItem("ytCache");
  init();
}

async function init(){
  const {c1,c2}=await getData();
  display(c1,"c1");
  display(c2,"c2");
  updateChart();
  updateRankingTable();
  computeWinner(c1,c2);
}

setInterval(init,UI_REFRESH_MIN*60000);
init();
</script>
</body>
</html>
